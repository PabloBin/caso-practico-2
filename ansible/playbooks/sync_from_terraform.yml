---
- name: Sync Ansible inventory/vars from Terraform outputs
  hosts: localhost
  connection: local
  gather_facts: false

  vars:
    terraform_dir: "{{ (playbook_dir + '/../../terraform') | realpath }}"
    inventory_path: "{{ (playbook_dir + '/../inventories/azure/inventory.ini') | realpath }}"
    tf_vars_path: "{{ (playbook_dir + '/../group_vars/all/terraform.yml') | realpath }}"

    required_outputs:
      - resource_group_name
      - location
      - acr_name
      - acr_login_server
      - vm_public_ip
      - vm_name
      - vm_admin_username
      - ssh_private_key_path
      - ssh_public_key_path
      - aks_name
      - aks_resource_group

  tasks:
    - name: Read Terraform outputs
      community.general.terraform_output:
        project_path: "{{ terraform_dir }}"
      register: tf

    - name: Validate required Terraform outputs exist
      ansible.builtin.assert:
        that: "{{ required_outputs | map('in', tf.outputs.keys() | list) | list | min }}"
        fail_msg: >
          Faltan outputs en Terraform. Esperados: {{ required_outputs }}.
          Disponibles: {{ tf.outputs.keys() | list }}

    - name: Build simplified output map
      ansible.builtin.set_fact:
        tf_map:
          resource_group_name: "{{ tf.outputs.resource_group_name.value }}"
          location: "{{ tf.outputs.location.value }}"
          acr_name: "{{ tf.outputs.acr_name.value }}"
          acr_login_server: "{{ tf.outputs.acr_login_server.value }}"
          vm_public_ip: "{{ tf.outputs.vm_public_ip.value }}"
          vm_name: "{{ tf.outputs.vm_name.value }}"
          vm_admin_username: "{{ tf.outputs.vm_admin_username.value }}"
          ssh_private_key_path: "{{ tf.outputs.ssh_private_key_path.value }}"
          ssh_public_key_path: "{{ tf.outputs.ssh_public_key_path.value }}"
          aks_name: "{{ tf.outputs.aks_name.value }}"
          aks_resource_group: "{{ tf.outputs.aks_resource_group.value }}"

    - name: Write group_vars/all/terraform.yml
      ansible.builtin.template:
        src: "{{ (playbook_dir + '/../templates/terraform-vars.yml.j2') | realpath }}"
        dest: "{{ tf_vars_path }}"
        mode: "0644"

    - name: Write inventories/azure/inventory.ini
      ansible.builtin.template:
        src: "{{ (playbook_dir + '/../templates/inventory.ini.j2') | realpath }}"
        dest: "{{ inventory_path }}"
        mode: "0644"

    - name: Show summary
      ansible.builtin.debug:
        msg:
          - "Generated: {{ tf_vars_path }}"
          - "Generated: {{ inventory_path }}"
          - "VM IP: {{ tf_map.vm_public_ip }}, user: {{ tf_map.vm_admin_username }}"
          - "ACR: {{ tf_map.acr_login_server }}"
          - "AKS: {{ tf_map.aks_name }} (RG: {{ tf_map.aks_resource_group }})"