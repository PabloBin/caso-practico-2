---
- name: Desplegar nginx-secure en VM Azure (Podman + TLS + Basic Auth) desde ACR
  hosts: vm
  gather_facts: true

  tasks:
    - name: Validar variables obligatorias
      ansible.builtin.assert:
        that:
          - acr_login_server is defined
          - acr_username is defined
          - acr_password is defined
          - nginx_secure_image is defined
          - basic_auth_user is defined
          - basic_auth_password is defined
        fail_msg: "Faltan variables en group_vars/vm.yml (ACR o BasicAuth)."

    - name: Instalar dependencias (passlib/crypto) para htpasswd y certificados
      become: true
      ansible.builtin.apt:
        update_cache: true
        name:
          - python3-passlib
          - python3-cryptography
        state: present

    - name: Login en ACR (Podman)
      no_log: true
      containers.podman.podman_login:
        registry: "{{ acr_login_server }}"
        username: "{{ acr_username }}"
        password: "{{ acr_password }}"

    - name: Asegurar carpetas nginx-secure
      ansible.builtin.file:
        path: "{{ item }}"
        state: directory
        owner: "{{ ansible_user }}"
        group: "{{ ansible_user }}"
        mode: "0755"
      loop:
        - "{{ nginx_secure_dir }}"
        - "{{ nginx_secure_dir }}/conf"
        - "{{ nginx_secure_dir }}/cert"

    - name: Crear config nginx (TLS + Basic Auth)
      ansible.builtin.copy:
        dest: "{{ nginx_secure_dir }}/conf/default.conf"
        mode: "0644"
        content: |
          server {
              listen 443 ssl;
              server_name _;

              ssl_certificate     /etc/nginx/cert/server.crt;
              ssl_certificate_key /etc/nginx/cert/server.key;

              location / {
                  auth_basic "Restricted";
                  auth_basic_user_file /etc/nginx/conf/.htpasswd;

                  root /usr/share/nginx/html;
                  index index.html;
              }
          }

    - name: Crear htpasswd (Basic Auth)
      community.general.htpasswd:
        path: "{{ nginx_secure_dir }}/conf/.htpasswd"
        name: "{{ basic_auth_user }}"
        password: "{{ basic_auth_password }}"
        crypt_scheme: apr_md5_crypt
        mode: "0644"
        owner: "{{ ansible_user }}"
        group: "{{ ansible_user }}"

    - name: Generar clave privada (si no existe)
      community.crypto.openssl_privatekey:
        path: "{{ nginx_secure_dir }}/cert/server.key"
        size: 2048
        type: RSA
        mode: "0600"

    - name: Generar CSR (si no existe) con CN={{ ansible_host }}
      community.crypto.openssl_csr:
        path: "{{ nginx_secure_dir }}/cert/server.csr"
        privatekey_path: "{{ nginx_secure_dir }}/cert/server.key"
        common_name: "{{ ansible_host }}"
        mode: "0644"

    - name: Generar certificado autofirmado (si no existe) desde CSR
      community.crypto.x509_certificate:
        path: "{{ nginx_secure_dir }}/cert/server.crt"
        privatekey_path: "{{ nginx_secure_dir }}/cert/server.key"
        csr_path: "{{ nginx_secure_dir }}/cert/server.csr"
        provider: selfsigned
        selfsigned_not_after: "+365d"
        mode: "0644"

    - name: Pull de la imagen nginx-secure desde ACR
      containers.podman.podman_image:
        name: "{{ nginx_secure_image }}"

    - name: Asegurar contenedor nginx-secure corriendo
      containers.podman.podman_container:
        name: "{{ nginx_secure_name }}"
        image: "{{ nginx_secure_image }}"
        state: started
        restart_policy: always
        publish:
          - "{{ nginx_secure_host_port }}:443"
        volume:
          - "{{ nginx_secure_dir }}/conf/default.conf:/etc/nginx/conf.d/default.conf:ro"
          - "{{ nginx_secure_dir }}/conf/.htpasswd:/etc/nginx/conf/.htpasswd:ro"
          - "{{ nginx_secure_dir }}/cert:/etc/nginx/cert:ro"

    - name: Validación local en la VM (401 sin auth)
      ansible.builtin.uri:
        url: "https://localhost:{{ nginx_secure_host_port }}/"
        method: GET
        validate_certs: false
        return_content: false
        status_code: 401
      register: check_unauth
      changed_when: false

    - name: Mostrar resultado 401 sin auth
      ansible.builtin.debug:
        msg: "Sin credenciales: HTTP {{ check_unauth.status }}"

    - name: Validación local en la VM (200 con auth)
      no_log: true
      ansible.builtin.uri:
        url: "https://localhost:{{ nginx_secure_host_port }}/"
        method: GET
        validate_certs: false
        return_content: false
        status_code: 200
        force_basic_auth: true
        url_username: "{{ basic_auth_user }}"
        url_password: "{{ basic_auth_password }}"
      register: check_auth
      changed_when: false

    - name: Mostrar resultado 200 con auth
      ansible.builtin.debug:
        msg: "Con credenciales: HTTP {{ check_auth.status }}"