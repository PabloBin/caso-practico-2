- name: Create Kubernetes secrets for CP2 (from Ansible Vault)
  hosts: localhost
  connection: local
  gather_facts: false
  vars_files:
    - group_vars/vault.yml

  tasks:
    - name: Render redis secret manifest (local)
      ansible.builtin.template:
        src: templates/redis-secret.yaml.j2
        dest: /tmp/redis-secret.yaml
        mode: "0600"

    - name: Apply redis secret to AKS (kubectl)
      ansible.builtin.command: kubectl apply -f /tmp/redis-secret.yaml
      register: kubectl_apply
      changed_when: "'configured' in kubectl_apply.stdout or 'created' in kubectl_apply.stdout"